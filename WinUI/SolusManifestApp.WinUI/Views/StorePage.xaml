<Page
    x:Class="SolusManifestApp.WinUI.Views.StorePage"
    x:Name="Root"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:SolusManifestApp.Core.Models"
    mc:Ignorable="d">

    <Page.Resources>
        <!-- Grid View Template (Vertical Cards) -->
        <DataTemplate x:Key="GridViewTemplate" x:DataType="models:LibraryGame">
            <Border Width="240" Height="300" Margin="0,0,15,15"
                    Background="{ThemeResource CardBackgroundAcrylicBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorBrush}"
                    BorderThickness="1" CornerRadius="8" Padding="0">
                <Border.Shadow><ThemeShadow /></Border.Shadow>
                <Border.Translation>0,0,8</Border.Translation>

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="130"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Game Image -->
                    <Border Grid.Row="0" Background="#222222" CornerRadius="8,8,0,0">
                        <Grid>
                            <Image Source="{x:Bind CachedIconPath, Mode=OneWay}" Stretch="UniformToFill"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            <TextBlock Text="ðŸŽ®" FontSize="48" HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Foreground="{ThemeResource SystemAccentColor}"
                                       Visibility="{x:Bind CachedIconPath, Mode=OneWay, Converter={StaticResource NullToVisibilityInverseConverter}}"/>
                            <Border Padding="8,4" CornerRadius="4" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="8">
                                <Border.Background>
                                    <SolidColorBrush Color="{x:Bind ManifestAvailable, Mode=OneWay, Converter={StaticResource BoolToStatusColorConverter}}"/>
                                </Border.Background>
                                <TextBlock FontSize="10" FontWeight="Bold" Foreground="White"
                                           Text="{x:Bind ManifestAvailable, Mode=OneWay, Converter={StaticResource BoolToStatusTextConverter}}"/>
                            </Border>
                        </Grid>
                    </Border>

                    <!-- Game Info -->
                    <StackPanel Grid.Row="1" Padding="12" Spacing="6">
                        <TextBlock Text="{x:Bind GameName, Mode=OneWay}" FontSize="15" FontWeight="SemiBold"
                                   MaxLines="2" TextWrapping="Wrap" TextTrimming="CharacterEllipsis"/>
                        <TextBlock FontSize="11" Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                            <Run Text="App ID:"/><Run Text="{x:Bind GameId, Mode=OneWay}"/>
                        </TextBlock>
                    </StackPanel>

                    <!-- Bottom Section -->
                    <StackPanel Grid.Row="2" Padding="12" Spacing="8">
                        <TextBlock FontSize="10" Foreground="{ThemeResource TextFillColorSecondaryBrush}" HorizontalAlignment="Center">
                            <Run Text="{x:Bind ManifestSize, Mode=OneWay, Converter={StaticResource BytesToStringConverter}}"/>
                            <Run Text=" | "/>
                            <Run Text="Added:"/>
                            <Run Text="{x:Bind UploadedDate, Mode=OneWay, Converter={StaticResource DateToStringConverter}}"/>
                        </TextBlock>
                        <Button HorizontalAlignment="Stretch"
                                Command="{Binding ElementName=Root, Path=ViewModel.DownloadGameCommand}"
                                CommandParameter="{x:Bind}"
                                IsEnabled="{x:Bind ManifestAvailable, Mode=OneWay}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="â¬‡ï¸"/>
                                <TextBlock Text="Download"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- List View Template (Horizontal Cards) -->
        <DataTemplate x:Key="ListViewTemplate" x:DataType="models:LibraryGame">
            <Border Height="100" Margin="0,0,0,10"
                    Background="{ThemeResource CardBackgroundAcrylicBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorBrush}"
                    BorderThickness="1" CornerRadius="8" Padding="10">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="140"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Game Image (Left) -->
                    <Border Grid.Column="0" Background="#222222" CornerRadius="8" Margin="0,0,10,0">
                        <Grid>
                            <Image Source="{x:Bind CachedIconPath, Mode=OneWay}" Stretch="Uniform"/>
                            <TextBlock Text="ðŸŽ®" FontSize="36" HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Foreground="{ThemeResource SystemAccentColor}"
                                       Visibility="{x:Bind CachedIconPath, Mode=OneWay, Converter={StaticResource NullToVisibilityInverseConverter}}"/>
                        </Grid>
                    </Border>

                    <!-- Game Info (Center) -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="4">
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <Border Padding="6,3" CornerRadius="4">
                                <Border.Background>
                                    <SolidColorBrush Color="{x:Bind ManifestAvailable, Mode=OneWay, Converter={StaticResource BoolToStatusColorConverter}}"/>
                                </Border.Background>
                                <TextBlock FontSize="10" FontWeight="Bold" Foreground="White"
                                           Text="{x:Bind ManifestAvailable, Mode=OneWay, Converter={StaticResource BoolToStatusTextConverter}}"/>
                            </Border>
                            <TextBlock Text="{x:Bind GameName, Mode=OneWay}" FontSize="14" FontWeight="SemiBold"
                                       VerticalAlignment="Center" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"/>
                        </StackPanel>
                        <TextBlock Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="11">
                            <Run Text="App ID:"/><Run Text="{x:Bind GameId, Mode=OneWay}"/>
                            <Run Text="  â€¢  "/>
                            <Run Text="{x:Bind ManifestSize, Mode=OneWay, Converter={StaticResource BytesToStringConverter}}"/>
                            <Run Text="  â€¢  "/>
                            <Run Text="{x:Bind UploadedDate, Mode=OneWay, Converter={StaticResource DateToStringConverter}}"/>
                        </TextBlock>
                    </StackPanel>

                    <!-- Actions (Right) -->
                    <Button Grid.Column="2" VerticalAlignment="Center" Padding="15,8"
                            Command="{Binding ElementName=Root, Path=ViewModel.DownloadGameCommand}"
                            CommandParameter="{x:Bind}"
                            IsEnabled="{x:Bind ManifestAvailable, Mode=OneWay}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="â¬‡ï¸"/>
                            <TextBlock Text="Download"/>
                        </StackPanel>
                    </Button>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- Grid Panel Template -->
        <ItemsPanelTemplate x:Key="GridPanelTemplate">
            <ItemsWrapGrid Orientation="Horizontal"/>
        </ItemsPanelTemplate>

        <!-- List Panel Template -->
        <ItemsPanelTemplate x:Key="ListPanelTemplate">
            <StackPanel Orientation="Vertical"/>
        </ItemsPanelTemplate>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Padding="40,40,40,20" Spacing="12">
            <TextBlock
                Text="Store"
                Style="{StaticResource TitleTextBlockStyle}"/>

            <TextBlock
                Text="Browse and download game manifests"
                Style="{StaticResource BodyTextBlockStyle}"
                Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
        </StackPanel>

        <!-- Search Bar and Controls -->
        <StackPanel Grid.Row="1" Padding="40,0,40,20" Spacing="12">
            <Grid ColumnSpacing="12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBox
                    Grid.Column="0"
                    PlaceholderText="Search games..."
                    Text="{x:Bind ViewModel.SearchQuery, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                    <TextBox.KeyboardAccelerators>
                        <KeyboardAccelerator Key="Enter" Invoked="SearchBox_EnterPressed"/>
                    </TextBox.KeyboardAccelerators>
                </TextBox>

                <Button
                    Grid.Column="1"
                    Command="{x:Bind ViewModel.SearchGamesCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE721;" FontSize="16"/>
                        <TextBlock Text="Search"/>
                    </StackPanel>
                </Button>
            </Grid>

            <!-- Status and Sort Options -->
            <TextBlock
                Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                FontSize="12"/>

            <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock
                    Text="Sort:"
                    VerticalAlignment="Center"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>

                <Button Command="{x:Bind ViewModel.SortByUpdatedCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="ðŸ“…"/>
                        <TextBlock Text="Recent"/>
                    </StackPanel>
                </Button>

                <Button Command="{x:Bind ViewModel.SortByNameCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="ðŸ”¤"/>
                        <TextBlock Text="A-Z"/>
                    </StackPanel>
                </Button>

                <Button Command="{x:Bind ViewModel.LoadGamesCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="ðŸ”„"/>
                        <TextBlock Text="Load"/>
                    </StackPanel>
                </Button>

                <Button Command="{x:Bind ViewModel.ToggleViewCommand}"
                        Width="32" Height="32" Padding="0"
                        ToolTipService.ToolTip="Toggle Grid/List View">
                    <FontIcon x:Name="ViewIcon" Glyph="&#xE8A9;" FontSize="14"/>
                </Button>
            </StackPanel>
        </StackPanel>

        <!-- Games Grid/List -->
        <ScrollViewer
            Grid.Row="2"
            Padding="40,0,40,20"
            VerticalScrollBarVisibility="Auto">
            <ItemsControl x:Name="GamesItemsControl"
                          ItemsSource="{x:Bind ViewModel.Games, Mode=OneWay}"
                          ItemTemplate="{StaticResource GridViewTemplate}"
                          ItemsPanel="{StaticResource GridPanelTemplate}"/>

        </ScrollViewer>

        <!-- Pagination Controls -->
        <StackPanel
            Grid.Row="3"
            Padding="40,0,40,40"
            Orientation="Horizontal"
            HorizontalAlignment="Center"
            Spacing="12">
            <Button
                Content="â¬…ï¸"
                Command="{x:Bind ViewModel.PreviousPageCommand}"
                IsEnabled="{x:Bind ViewModel.CanGoPrevious, Mode=OneWay}"
                Padding="12,8"/>

            <TextBlock
                VerticalAlignment="Center"
                Margin="8,0">
                <Run Text="Page"/>
                <Run Text="{x:Bind ViewModel.CurrentPage, Mode=OneWay}"/>
                <Run Text="of"/>
                <Run Text="{x:Bind ViewModel.TotalPages, Mode=OneWay}"/>
            </TextBlock>

            <Button
                Content="âž¡ï¸"
                Command="{x:Bind ViewModel.NextPageCommand}"
                IsEnabled="{x:Bind ViewModel.CanGoNext, Mode=OneWay}"
                Padding="12,8"/>
        </StackPanel>

        <!-- Loading Indicator -->
        <Grid
            Grid.RowSpan="4"
            Background="{ThemeResource CardBackgroundAcrylicBrush}"
            Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <ProgressRing
                Width="60"
                Height="60"
                IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"/>
        </Grid>
    </Grid>
</Page>