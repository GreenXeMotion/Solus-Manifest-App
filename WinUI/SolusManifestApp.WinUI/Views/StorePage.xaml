<Page
    x:Class="SolusManifestApp.WinUI.Views.StorePage"
    x:Name="Root"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Padding="40,40,40,20" Spacing="12">
            <TextBlock
                Text="Store"
                Style="{StaticResource TitleTextBlockStyle}"/>

            <TextBlock
                Text="Browse and download game manifests"
                Style="{StaticResource BodyTextBlockStyle}"
                Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
        </StackPanel>

        <!-- Search Bar and Controls -->
        <StackPanel Grid.Row="1" Padding="40,0,40,20" Spacing="12">
            <Grid ColumnSpacing="12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBox
                    Grid.Column="0"
                    PlaceholderText="Search games..."
                    Text="{x:Bind ViewModel.SearchQuery, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                    <TextBox.KeyboardAccelerators>
                        <KeyboardAccelerator Key="Enter" Invoked="SearchBox_EnterPressed"/>
                    </TextBox.KeyboardAccelerators>
                </TextBox>

                <Button
                    Grid.Column="1"
                    Command="{x:Bind ViewModel.SearchGamesCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE721;" FontSize="16"/>
                        <TextBlock Text="Search"/>
                    </StackPanel>
                </Button>
            </Grid>

            <!-- Status and Sort Options -->
            <TextBlock
                Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                FontSize="12"/>

            <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock
                    Text="Sort:"
                    VerticalAlignment="Center"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>

                <Button Command="{x:Bind ViewModel.SortByUpdatedCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="ðŸ“…"/>
                        <TextBlock Text="Recent"/>
                    </StackPanel>
                </Button>

                <Button Command="{x:Bind ViewModel.SortByNameCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="ðŸ”¤"/>
                        <TextBlock Text="A-Z"/>
                    </StackPanel>
                </Button>

                <Button Command="{x:Bind ViewModel.LoadGamesCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="ðŸ”„"/>
                        <TextBlock Text="Load"/>
                    </StackPanel>
                </Button>

                <Button Command="{x:Bind ViewModel.ToggleViewCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="{x:Bind ViewModel.IsListView, Mode=OneWay, Converter={StaticResource BoolToViewIconConverter}}"/>
                        <TextBlock Text="{x:Bind ViewModel.IsListView, Mode=OneWay, Converter={StaticResource BoolToViewTextConverter}}"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </StackPanel>

        <!-- Games Grid/List -->
        <ScrollViewer
            Grid.Row="2"
            Padding="40,0,40,20"
            VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{x:Bind ViewModel.Games, Mode=OneWay}">
                <!-- Grid View Panel -->
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <ItemsWrapGrid Orientation="Horizontal" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="models:LibraryGame" xmlns:models="using:SolusManifestApp.Core.Models">
                        <Border
                            Width="280"
                            Height="350"
                            Margin="0,0,20,20"
                            Background="{ThemeResource CardBackgroundAcrylicBrush}"
                            BorderBrush="{ThemeResource CardStrokeColorBrush}"
                            BorderThickness="1"
                            CornerRadius="8"
                            Padding="0">
                            <Border.Shadow>
                                <ThemeShadow />
                            </Border.Shadow>
                            <Border.Translation>0,0,8</Border.Translation>

                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="160"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <!-- Game Image -->
                                <Border
                                    Grid.Row="0"
                                    Background="#222222"
                                    CornerRadius="8,8,0,0">
                                    <Grid>
                                        <!-- Cached Image -->
                                        <Image
                                            Source="{x:Bind CachedIconPath, Mode=OneWay}"
                                            Stretch="UniformToFill"
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"/>

                                        <!-- Placeholder -->
                                        <TextBlock
                                            Text="ðŸŽ®"
                                            FontSize="64"
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Foreground="{ThemeResource SystemAccentColor}"
                                            Visibility="{x:Bind CachedIconPath, Mode=OneWay, Converter={StaticResource NullToVisibilityInverseConverter}}"/>

                                        <!-- Status Badge -->
                                        <Border
                                            Padding="8,4"
                                            CornerRadius="4"
                                            HorizontalAlignment="Right"
                                            VerticalAlignment="Top"
                                            Margin="8">
                                            <Border.Background>
                                                <SolidColorBrush Color="{x:Bind ManifestAvailable, Mode=OneWay, Converter={StaticResource BoolToStatusColorConverter}}"/>
                                            </Border.Background>
                                            <TextBlock
                                                FontSize="10"
                                                FontWeight="Bold"
                                                Foreground="White"
                                                Text="{x:Bind ManifestAvailable, Mode=OneWay, Converter={StaticResource BoolToStatusTextConverter}}"/>
                                        </Border>
                                    </Grid>
                                </Border>

                                <!-- Game Info -->
                                <StackPanel Grid.Row="1" Padding="12" Spacing="6">
                                    <TextBlock
                                        Text="{x:Bind GameName, Mode=OneWay}"
                                        FontSize="15"
                                        FontWeight="SemiBold"
                                        MaxLines="2"
                                        TextWrapping="Wrap"
                                        TextTrimming="CharacterEllipsis"/>

                                    <TextBlock
                                        FontSize="11"
                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                                        <Run Text="App ID:"/>
                                        <Run Text="{x:Bind GameId, Mode=OneWay}"/>
                                    </TextBlock>
                                </StackPanel>

                                <!-- Bottom Section -->
                                <StackPanel Grid.Row="2" Padding="12" Spacing="8">
                                    <TextBlock
                                        FontSize="10"
                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                        HorizontalAlignment="Center">
                                        <Run Text="{x:Bind ManifestSize, Mode=OneWay, Converter={StaticResource BytesToStringConverter}}"/>
                                        <Run Text=" | "/>
                                        <Run Text="Added:"/>
                                        <Run Text="{x:Bind UploadedDate, Mode=OneWay, Converter={StaticResource DateToStringConverter}}"/>
                                    </TextBlock>

                                    <Button
                                        HorizontalAlignment="Stretch"
                                        Command="{Binding ElementName=Root, Path=ViewModel.DownloadGameCommand}"
                                        CommandParameter="{x:Bind}"
                                        IsEnabled="{x:Bind ManifestAvailable, Mode=OneWay}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Text="â¬‡ï¸"/>
                                            <TextBlock Text="Download"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Pagination Controls -->
        <StackPanel
            Grid.Row="3"
            Padding="40,0,40,40"
            Orientation="Horizontal"
            HorizontalAlignment="Center"
            Spacing="12">
            <Button
                Content="â¬…ï¸"
                Command="{x:Bind ViewModel.PreviousPageCommand}"
                IsEnabled="{x:Bind ViewModel.CanGoPrevious, Mode=OneWay}"
                Padding="12,8"/>

            <TextBlock
                VerticalAlignment="Center"
                Margin="8,0">
                <Run Text="Page"/>
                <Run Text="{x:Bind ViewModel.CurrentPage, Mode=OneWay}"/>
                <Run Text="of"/>
                <Run Text="{x:Bind ViewModel.TotalPages, Mode=OneWay}"/>
            </TextBlock>

            <Button
                Content="âž¡ï¸"
                Command="{x:Bind ViewModel.NextPageCommand}"
                IsEnabled="{x:Bind ViewModel.CanGoNext, Mode=OneWay}"
                Padding="12,8"/>
        </StackPanel>

        <!-- Loading Indicator -->
        <Grid
            Grid.RowSpan="4"
            Background="{ThemeResource CardBackgroundAcrylicBrush}"
            Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <ProgressRing
                Width="60"
                Height="60"
                IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"/>
        </Grid>
    </Grid>
</Page>