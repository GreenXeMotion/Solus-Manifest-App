<Page x:Class="SolusManifestApp.WinUI.Views.LibraryPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:models="using:SolusManifestApp.Core.Models"
      mc:Ignorable="d"
      x:Name="Root"
      Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
      AllowDrop="True"
      DragOver="Page_DragOver"
      Drop="Page_Drop">

    <Page.Resources>
        <ThemeShadow x:Name="SharedShadow" />

        <!-- Grid View Template (Vertical Cards) -->
        <DataTemplate x:Key="GridViewTemplate" x:DataType="models:LibraryItem">
            <Border Width="280"
                    Height="350"
                    Margin="0,0,20,20"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="8"
                    Shadow="{StaticResource SharedShadow}"
                    Translation="0,0,16">
                <Border.ContextFlyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="âž• Add to GreenLuma"
                                        Command="{Binding ElementName=Root, Path=ViewModel.AddToGreenLumaCommand}"
                                        CommandParameter="{x:Bind}"/>
                        <MenuFlyoutItem Text="âž– Remove from GreenLuma"
                                        Command="{Binding ElementName=Root, Path=ViewModel.RemoveFromGreenLumaCommand}"
                                        CommandParameter="{x:Bind}"/>
                        <MenuFlyoutSeparator/>
                        <MenuFlyoutItem Text="ðŸ—‘ï¸ Uninstall"
                                        Command="{Binding ElementName=Root, Path=ViewModel.UninstallGameCommand}"
                                        CommandParameter="{x:Bind}"/>
                    </MenuFlyout>
                </Border.ContextFlyout>

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="160"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Game Image -->
                    <Border Grid.Row="0" Background="#222222" CornerRadius="8,8,0,0">
                        <Grid>
                            <Image Source="{x:Bind CachedIconPath, Mode=OneWay}" Stretch="Uniform"/>
                            <TextBlock Text="ðŸŽ®" FontSize="64" HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Visibility="{x:Bind CachedIconPath, Mode=OneWay, Converter={StaticResource NullToVisibilityInverseConverter}}"/>
                            <Border Background="{ThemeResource AccentFillColorDefaultBrush}" Padding="8,4" CornerRadius="4"
                                    HorizontalAlignment="Right" VerticalAlignment="Top" Margin="8">
                                <TextBlock Text="{x:Bind TypeBadge}" FontSize="10" FontWeight="Bold" Foreground="White"/>
                            </Border>
                        </Grid>
                    </Border>

                    <!-- Game Info -->
                    <StackPanel Grid.Row="1" Padding="12,8,12,8" Spacing="4">
                        <TextBlock Text="{x:Bind Name}" FontSize="15" FontWeight="SemiBold" TextWrapping="Wrap" MaxLines="2" TextTrimming="CharacterEllipsis"/>
                        <TextBlock Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="11">
                            <Run Text="App ID: "/><Run Text="{x:Bind AppId}"/>
                        </TextBlock>
                        <TextBlock FontSize="10" Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                            <Run Text="{x:Bind SizeFormatted, Mode=OneWay}"/>
                        </TextBlock>
                    </StackPanel>

                    <!-- Actions -->
                    <StackPanel Grid.Row="2" Padding="12,8,12,12" Spacing="6">
                        <Button Content="â–¶ Launch" HorizontalAlignment="Stretch"
                                Command="{Binding ElementName=Root, Path=ViewModel.LaunchGameCommand}"
                                CommandParameter="{x:Bind}"/>
                        <Button Content="ðŸ—‘ï¸ Uninstall" HorizontalAlignment="Stretch"
                                Command="{Binding ElementName=Root, Path=ViewModel.UninstallGameCommand}"
                                CommandParameter="{x:Bind}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- List View Template (Horizontal Cards) -->
        <DataTemplate x:Key="ListViewTemplate" x:DataType="models:LibraryItem">
            <Border Height="100"
                    Margin="0,0,0,10"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="8"
                    Padding="10">
                <Border.ContextFlyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="âž• Add to GreenLuma"
                                        Command="{Binding ElementName=Root, Path=ViewModel.AddToGreenLumaCommand}"
                                        CommandParameter="{x:Bind}"/>
                        <MenuFlyoutItem Text="âž– Remove from GreenLuma"
                                        Command="{Binding ElementName=Root, Path=ViewModel.RemoveFromGreenLumaCommand}"
                                        CommandParameter="{x:Bind}"/>
                        <MenuFlyoutSeparator/>
                        <MenuFlyoutItem Text="ðŸ—‘ï¸ Uninstall"
                                        Command="{Binding ElementName=Root, Path=ViewModel.UninstallGameCommand}"
                                        CommandParameter="{x:Bind}"/>
                    </MenuFlyout>
                </Border.ContextFlyout>

                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="140"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Game Image (Left) -->
                    <Border Grid.Column="0" Background="#222222" CornerRadius="8" Margin="0,0,10,0">
                        <Grid>
                            <Image Source="{x:Bind CachedIconPath, Mode=OneWay}" Stretch="Uniform"/>
                            <TextBlock Text="ðŸŽ®" FontSize="36" HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Visibility="{x:Bind CachedIconPath, Mode=OneWay, Converter={StaticResource NullToVisibilityInverseConverter}}"/>
                        </Grid>
                    </Border>

                    <!-- Game Info (Center) -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="4">
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <Border Background="{ThemeResource AccentFillColorDefaultBrush}" Padding="6,3" CornerRadius="4">
                                <TextBlock Text="{x:Bind TypeBadge}" FontSize="10" FontWeight="Bold" Foreground="White"/>
                            </Border>
                            <TextBlock Text="{x:Bind Name}" FontSize="14" FontWeight="SemiBold" VerticalAlignment="Center"
                                       TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"/>
                        </StackPanel>
                        <TextBlock Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="11">
                            <Run Text="App ID: "/><Run Text="{x:Bind AppId}"/>
                            <Run Text="  â€¢  "/><Run Text="{x:Bind SizeFormatted, Mode=OneWay}"/>
                        </TextBlock>
                    </StackPanel>

                    <!-- Actions (Right) -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="10" VerticalAlignment="Center" Margin="10,0,0,0">
                        <Button Content="â–¶ Launch" Padding="15,8"
                                Command="{Binding ElementName=Root, Path=ViewModel.LaunchGameCommand}"
                                CommandParameter="{x:Bind}"/>
                        <Button Content="ðŸ—‘ï¸ Uninstall" Padding="15,8"
                                Command="{Binding ElementName=Root, Path=ViewModel.UninstallGameCommand}"
                                CommandParameter="{x:Bind}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- Grid Panel Template -->
        <ItemsPanelTemplate x:Key="GridPanelTemplate">
            <ItemsWrapGrid Orientation="Horizontal"/>
        </ItemsPanelTemplate>

        <!-- List Panel Template -->
        <ItemsPanelTemplate x:Key="ListPanelTemplate">
            <StackPanel Orientation="Vertical"/>
        </ItemsPanelTemplate>
    </Page.Resources>

    <Grid Margin="30">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Header + Stats -->
            <RowDefinition Height="Auto"/>
            <!-- Search and Filters -->
            <RowDefinition Height="*"/>
            <!-- Content -->
        </Grid.RowDefinitions>

        <!-- Header with Statistics -->
        <StackPanel Grid.Row="0" Margin="0,0,0,15">
            <TextBlock Text="Library"
                       FontSize="28"
                       FontWeight="Bold"
                       Margin="0,0,0,10"/>

            <!-- Action Buttons -->
            <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,0,10">
                <Button Command="{x:Bind ViewModel.RefreshLibraryCommand}"
                        Style="{StaticResource AccentButtonStyle}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="ðŸ”„" FontSize="14"/>
                        <TextBlock Text="Refresh"/>
                    </StackPanel>
                </Button>
            </StackPanel>

            <!-- Statistics Dashboard -->
            <StackPanel Orientation="Horizontal" Spacing="8">
                <!-- Total Games Card -->
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        Padding="16,12"
                        CornerRadius="8"
                        MinWidth="110">
                    <StackPanel Spacing="4">
                        <TextBlock Text="{x:Bind ViewModel.TotalGames, Mode=OneWay}"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="Total"
                                   FontSize="11"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <!-- Lua Scripts Card -->
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        Padding="16,12"
                        CornerRadius="8"
                        MinWidth="110">
                    <StackPanel Spacing="4">
                        <TextBlock Text="{x:Bind ViewModel.LuaScriptsCount, Mode=OneWay}"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="Lua"
                                   FontSize="11"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <!-- GreenLuma Card -->
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        Padding="16,12"
                        CornerRadius="8"
                        MinWidth="110">
                    <StackPanel Spacing="4">
                        <TextBlock Text="{x:Bind ViewModel.GreenLumaGamesCount, Mode=OneWay}"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="GreenLuma"
                                   FontSize="11"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <!-- Steam Games Card -->
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        Padding="16,12"
                        CornerRadius="8"
                        MinWidth="110">
                    <StackPanel Spacing="4">
                        <TextBlock Text="{x:Bind ViewModel.SteamGamesCount, Mode=OneWay}"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="Steam"
                                   FontSize="11"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </StackPanel>

        <!-- Search and Filters -->
        <Grid Grid.Row="1" Margin="0,0,0,20" ColumnSpacing="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MinWidth="150"/>
                <ColumnDefinition Width="150"/>
                <ColumnDefinition Width="180"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Search Box -->
            <TextBox Grid.Column="0"
                     Text="{x:Bind ViewModel.SearchQuery, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                     PlaceholderText="ðŸ” Search by name, App ID, or description..."
                     Height="32"
                     VerticalAlignment="Center"/>

            <!-- Filter ComboBox -->
            <ComboBox Grid.Column="1"
                      ItemsSource="{x:Bind ViewModel.FilterOptions}"
                      SelectedItem="{x:Bind ViewModel.FilterMode, Mode=TwoWay}"
                      HorizontalAlignment="Stretch"
                      Height="32"/>

            <!-- Profile Selector -->
            <ComboBox Grid.Column="2"
                      ItemsSource="{x:Bind ViewModel.Profiles}"
                      SelectedItem="{x:Bind ViewModel.ActiveProfile, Mode=TwoWay}"
                      DisplayMemberPath="Name"
                      HorizontalAlignment="Stretch"
                      Height="32"
                      PlaceholderText="Select profile"/>

            <!-- View Toggle Button -->
            <Button Grid.Column="3"
                    Command="{x:Bind ViewModel.ToggleViewCommand}"
                    Width="32"
                    Height="32"
                    Padding="0"
                    ToolTipService.ToolTip="Toggle Grid/List View">
                <FontIcon x:Name="ViewIcon" Glyph="&#xE8A9;" FontSize="14"/>
            </Button>
        </Grid>

        <!-- Games Grid/List -->
        <ScrollViewer Grid.Row="2"
                      VerticalScrollBarVisibility="Auto">
            <ItemsControl x:Name="GamesItemsControl"
                          ItemsSource="{x:Bind ViewModel.LibraryItems, Mode=OneWay}"
                          ItemTemplate="{StaticResource GridViewTemplate}"
                          ItemsPanel="{StaticResource GridPanelTemplate}"/>
        </ScrollViewer>

        <!-- Loading Overlay -->
        <Grid Grid.Row="2"
              Background="#AA000000"
              Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="10">
                <ProgressRing Width="60"
                              Height="60"
                              IsActive="True"/>
                <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                           FontSize="18"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</Page>
